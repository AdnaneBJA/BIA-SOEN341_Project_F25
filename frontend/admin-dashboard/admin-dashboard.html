<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../main-page/mainpage.css">
    <link rel="stylesheet" href="admin-dashboard.css">
    <title>Admin Dashboard - BIA</title>

    <script src="../admin-login/admin-login.js"></script>
    <script>
        // FYI, this makes the page inaccessible unless the admin is logged in
        protectAdminPage();
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

</head>
<body>

    <!--For the charts-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <nav class="menu-bar">
        <div class="menu-left">
            <span class="menu-logo"><b>BIA</b></span>
        </div>
        <div class="menu-center">
            <a href="../main-page/mainpage.html">Home</a>
        </div>
        <div class="menu-right">
            <div class="menu-status">
                <span id="user-status">Admin</span>
                <button id="disconnect-btn" class="disconnect-btn" type="button">Disconnect</button>
            </div>
        </div>
    </nav>

    <main class="center-content hero" style="margin-top:40px; gap:12px;">
        <h1>Admin Dashboard</h1>
        <p class="subtitle">Welcome to the admin area. Manage organizers, review events, and view platform analytics.</p>

        <section style="width:95%; max-width:1400px; margin-top:18px;">
            <div style="background:#fff; border-radius:12px; padding:18px; box-shadow:0 4px 12px rgba(0,0,0,0.08);">
                <h2 style="margin-top:0;">Quick Actions</h2>
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <button onclick="location.href='../approve-organizer-page/approve-organizer.html'">Approve Organizer</button>
                    <button onclick="location.href='../moderate-event-listing/moderate-event-listing.html'">Moderate Event Listing</button>
                </div>
            </div>

            <div style="background:#fff; border-radius:12px; padding:18px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-top:16px;">
                <h2 style="margin-top:0;">Platform Statistics</h2>
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="text-align:left; border-bottom:2px solid #eaded3;">
                            <th style="padding:8px">Metric</th>
                            <th style="padding:8px">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- CHANGE VALUES -->
                        <tr style="border-bottom:1px solid #f0eaea;">
                            <td style="padding:8px">Tickets Issued</td>
                            <td style="padding:8px"><span id="totalTickets">0</span></td>
                        </tr>
                        <tr style="border-bottom:1px solid #f0eaea;">
                            <td style="padding:8px">Total Events</td>
                            <td style="padding:8px"><span id="totalEvents">0</span></td>
                        </tr>
                        <tr style="border-bottom:1px solid #f0eaea;">
                            <td style="padding:8px">Total Participants</td>
                            <td style="padding:8px"><span id="totalParticipants">0</span></td>
                        </tr>
                        <!-- <tr style="border-bottom:1px solid #f0eaea;">
                            <td style="padding:8px">Active Events</td>
                            <td id="totalEventsValue" style="padding:8px">Loading…</td>
                        </tr>
                        <tr style="border-bottom:1px solid #f0eaea;">
                            <td style="padding:8px">Tickets Issued</td>
                            <td id="totalTicketsValue" style="padding:8px">Loading…</td>
                        </tr> -->
                    </tbody>
                </table>
                
            </div>

            <div style="background:#fff; border-radius:12px; padding:18px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-top:16px;">
                <h2 style="margin-top:0;">Participation trends</h2>
                <!-- Additional analytics-->
                <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: start;">
                    <canvas id="ticketsChart" style="max-width: 300px; height: 150px; margin-bottom: 2rem; margin-right: 40px"></canvas>
                    <canvas id="participationChart" style="max-width: 300px; height: 150px;"></canvas>
                </div>
            </div>

            <div style="background:#fff; border-radius:12px; padding:18px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-top:16px;">
                <h2 style="margin-top:0;">Management</h2>
                <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap;">
                    <!-- additional button below!!!!!!!!-->
                     <button class="admin-btn" id="manage-org-btn">Manage Organizations</button>
                     <button class="admin-btn" id="assign-roles-btn">Assign Roles</button>
                </div>
                <!-- addition below !!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
                 <div id="org-root" style="display:none; margin-top:20px;"></div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-inner">
            <span>© <span id="year"></span> BIA Events</span>
            <span class="dot">•</span>
            <a href="../event-discovery/event-discovery.html">Explore Events</a>
        </div>
    </footer>

    <!--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!ORGANIZATION!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!-->
  
    <script type="text/babel">
        function AdminOrganizations() {
            const [organizations, setOrganizations] = React.useState([]);
            const [form, setForm] = React.useState({ name: '', description: '' });
            const [message, setMessage] = React.useState('');

            React.useEffect(() => {
                fetch('http://localhost:3000/organizations')
                    .then(res => res.json())
                    .then(data => setOrganizations(data.organizations || []));
            }, []);

            function handleChange(e) {
                setForm({ ...form, [e.target.name]: e.target.value });
            }

            function handleCreate(e) {
                e.preventDefault();
                fetch('http://localhost:3000/organizations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(form)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.organization) {
                        setOrganizations([...organizations, data.organization]);
                        setMessage('Organization created successfully!');
                        setForm({ name: '', description: '' });
                        setTimeout(() => setMessage(''), 3000); 
                    } else {
                        setMessage('Failed to create organization.');
                    }
                })
                .catch(() => setMessage('Failed to create organization.'));
            }

            function handleDelete(name) {
                if (!confirm(`Are you sure you want to delete "${name}"?`)) return;
                fetch(`http://localhost:3000/organizations/${name}`, { method: 'DELETE' })
                    .then(() => setOrganizations(organizations.filter(org => org.name !== name)));
            }

            return (
                <div style={{
                    background: '#ffffff',
                    padding: '28px 32px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                }}>
                    <h2 style={{ marginTop: 0, color: '#5a4634', borderBottom: '2px solid #DECAB5', paddingBottom: '12px' }}>
                        Manage Organizations
                    </h2>

                    {message && (
                        <div style={{
                            background: message.includes('Failed') ? '#fee' : '#efe',
                            color: message.includes('Failed') ? '#c33' : '#383',
                            padding: '12px 16px',
                            borderRadius: '8px',
                            marginBottom: '20px',
                            border: `1px solid ${message.includes('Failed') ? '#fcc' : '#cfc'}`
                        }}>
                            {message}
                        </div>
                    )}

                    <div style={{
                        background: '#F6F1EC',
                        padding: '24px',
                        borderRadius: '10px',
                        marginBottom: '28px',
                        border: '1px solid #DECAB5'
                    }}>
                        <h3 style={{ marginTop: 0, marginBottom: '20px', color: '#5a4634', fontSize: '1.15em' }}>
                            Create New Organization
                        </h3>
                        <form onSubmit={handleCreate}>
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: '1fr 1fr',
                                gap: '20px',
                                marginBottom: '20px'
                            }}>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                    <label style={{ fontWeight: '600', color: '#5a4634', fontSize: '0.95em' }}>
                                        Organization Name *
                                    </label>
                                    <input
                                        name="name"
                                        value={form.name}
                                        onChange={handleChange}
                                        placeholder="Enter organization name"
                                        required
                                        style={{
                                            padding: '12px 16px',
                                            border: '1px solid #ddd',
                                            borderRadius: '8px',
                                            fontSize: '1em',
                                            background: '#ffffff',
                                            transition: 'border-color 0.2s ease',
                                            outline: 'none'
                                        }}
                                        onFocus={(e) => e.target.style.borderColor = '#AA8E70'}
                                        onBlur={(e) => e.target.style.borderColor = '#ddd'}
                                    />
                                </div>

                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                    <label style={{ fontWeight: '600', color: '#5a4634', fontSize: '0.95em' }}>
                                        Description
                                    </label>
                                    <input
                                        name="description"
                                        value={form.description}
                                        onChange={handleChange}
                                        placeholder="Enter organization description (optional)"
                                        style={{
                                            padding: '12px 16px',
                                            border: '1px solid #ddd',
                                            borderRadius: '8px',
                                            fontSize: '1em',
                                            background: '#ffffff',
                                            transition: 'border-color 0.2s ease',
                                            outline: 'none'
                                        }}
                                        onFocus={(e) => e.target.style.borderColor = '#AA8E70'}
                                        onBlur={(e) => e.target.style.borderColor = '#ddd'}
                                    />
                                </div>
                            </div>

                            <button
                                type="submit"
                                style={{
                                    background: '#AA8E70',
                                    color: '#ffffff',
                                    padding: '12px 32px',
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '1em',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    transition: 'background-color 0.2s ease'
                                }}
                                onMouseOver={(e) => e.target.style.background = '#8B7355'}
                                onMouseOut={(e) => e.target.style.background = '#AA8E70'}
                            >
                                Create Organization
                            </button>
                        </form>
                    </div>

                    <div>
                        <h3 style={{ marginTop: 0, marginBottom: '20px', color: '#5a4634', fontSize: '1.15em' }}>
                            Existing Organizations ({organizations.length})
                        </h3>
                        {organizations.length === 0 ? (
                            <p style={{ color: '#999', fontStyle: 'italic', padding: '24px', textAlign: 'center', background: '#f9f9f9', borderRadius: '8px' }}>
                                No organizations created yet.
                            </p>
                        ) : (
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fill, minmax(400px, 1fr))',
                                gap: '16px'
                            }}>
                                {organizations.map(org => (
                                    <div
                                        key={org.id}
                                        style={{
                                            background: '#ffffff',
                                            border: '1px solid #e0e0e0',
                                            borderRadius: '10px',
                                            padding: '20px',
                                            display: 'flex',
                                            flexDirection: 'column',
                                            transition: 'box-shadow 0.2s ease, transform 0.2s ease',
                                            boxShadow: '0 1px 3px rgba(0,0,0,0.05)',
                                            minHeight: '120px'
                                        }}
                                        onMouseOver={(e) => {
                                            e.currentTarget.style.boxShadow = '0 6px 16px rgba(0,0,0,0.1)';
                                            e.currentTarget.style.transform = 'translateY(-2px)';
                                        }}
                                        onMouseOut={(e) => {
                                            e.currentTarget.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)';
                                            e.currentTarget.style.transform = 'translateY(0)';
                                        }}
                                    >
                                        <div style={{ flex: 1, marginBottom: '12px' }}>
                                            <div style={{
                                                fontSize: '1.2em',
                                                fontWeight: '700',
                                                color: '#5a4634',
                                                marginBottom: '8px'
                                            }}>
                                                {org.name}
                                            </div>
                                            {org.description && (
                                                <div style={{
                                                    fontSize: '0.9em',
                                                    color: '#666',
                                                    lineHeight: '1.5',
                                                    marginBottom: '8px'
                                                }}>
                                                    {org.description}
                                                </div>
                                            )}
                                            {org.createdAt && (
                                                <div style={{
                                                    fontSize: '0.8em',
                                                    color: '#999',
                                                    fontStyle: 'italic'
                                                }}>
                                                    Created: {org.createdAt}
                                                </div>
                                            )}
                                        </div>
                                        <button
                                            onClick={() => handleDelete(org.name)}
                                            style={{
                                                background: '#dc3545',
                                                color: '#ffffff',
                                                border: 'none',
                                                padding: '10px 20px',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '0.9em',
                                                fontWeight: '600',
                                                transition: 'background-color 0.2s ease',
                                                alignSelf: 'flex-end'
                                            }}
                                            onMouseOver={(e) => e.target.style.background = '#bb2d3b'}
                                            onMouseOut={(e) => e.target.style.background = '#dc3545'}
                                        >
                                            Delete
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        
        document.getElementById('manage-org-btn').addEventListener('click', function() {
            const orgRoot = document.getElementById('org-root');
            orgRoot.style.display = 'block';
            ReactDOM.createRoot(orgRoot).render(<AdminOrganizations />);
        });
    </script>

  <!--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!ROLE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!-->
    <script type="text/babel">
        function RoleManager() {
            const [userId, setUserId] = React.useState('');
            const [role, setRole] = React.useState('Student');
            const [message, setMessage] = React.useState('');
            const [messageType, setMessageType] = React.useState(''); 

            async function handleAssign() {
                if (!userId) {
                    setMessageType('error');
                    setMessage('Please enter a user ID.');
                    return;
                }

                const res = await fetch('http://localhost:3000/roles/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, newRole: role, username: `${userId}`, password: `${userId}`})
                });

                const data = await res.json();
                if (res.ok) {
                    setMessageType('success');
                    setMessage(data.message || 'Role assigned successfully!');
                } else {
                    setMessageType('error');
                    setMessage(data.error || 'Failed to assign role.');
                }

                // Clear message after 5 seconds
                setTimeout(() => setMessage(''), 5000);
            }

            async function handleRevoke() {
                if (!userId) {
                    setMessageType('error');
                    setMessage('Please enter a user ID.');
                    return;
                }

                const res = await fetch(`http://localhost:3000/roles/revoke/${userId}`, {
                    method: 'DELETE'
                });

                const data = await res.json();
                if (res.ok) {
                    setMessageType('success');
                    setMessage(data.message || 'Role revoked successfully!');
                } else {
                    setMessageType('error');
                    setMessage(data.error || 'Failed to revoke role.');
                }

                // Clear message after 5 seconds
                setTimeout(() => setMessage(''), 5000);
            }

            return (
                <div style={{marginTop: '20px'}}>
                    <h2>Assign or Revoke Roles</h2>
                    <input
                        type="number"
                        placeholder="User ID"
                        value={userId}
                        onChange={e => setUserId(e.target.value)}
                        style={{marginRight: '8px'}}
                    />
                    <select value={role} onChange={e => setRole(e.target.value)}>
                        <option value="Student">Student</option>
                        <option value="Organizer">Organizer</option>
                        <option value="Admin">Administrator</option>
                    </select>
                    <div style={{marginTop: '10px'}}>
                        <button onClick={handleAssign}>Assign Role</button>
                        <button onClick={handleRevoke} style={{marginLeft: '10px'}}>Revoke Role</button>
                    </div>

                    {message && (
                        <p
                            style={{
                                marginTop: '10px',
                                color: messageType === 'success' ? 'green' : 'red',
                                fontWeight: 'bold',
                                transition: 'opacity 0.3s ease'
                            }}
                        >
                            {message}
                        </p>
                    )}
                </div>
            );
        }


        
        document.getElementById('assign-roles-btn').addEventListener('click', function() {
            const orgRoot = document.getElementById('org-root');
            orgRoot.style.display = 'block';
            ReactDOM.createRoot(orgRoot).render(<RoleManager />);
        });
    </script>

<!--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!ANALYTICS AND CHARTS!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!-->
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const baseUrl = 'http://localhost:3000/analytics'; 

        function createChart(ctx, type, labels, data, label) {
            return new Chart(ctx, {
                type,
                data: {
                    labels: labels.length ? labels : ['No data'],
                    datasets: [{
                        label,
                        data: data.length ? data : [0],
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        fill: type === 'line',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });
        }

        try {
            //For the Summary
            const summary = await fetch(`${baseUrl}/summary`).then(res => res.json());
            document.getElementById('totalEvents').textContent = summary.totalEvents;
            document.getElementById('totalTickets').textContent = summary.totalTickets;
            document.getElementById('totalParticipants').textContent = summary.totalParticipants;

            // For the Ticket trends
            const ticketData = await fetch(`${baseUrl}/tickets/monthly`).then(res => res.json());
            const ticketLabels = ticketData.map(row => new Date(row.month).toLocaleString('default', { month: 'short', year: 'numeric' }));
            const ticketCounts = ticketData.map(row => parseInt(row.tickets_sold));

            createChart(
                document.getElementById('ticketsChart'),
                'line',
                ticketLabels,
                ticketCounts,
                'Tickets Sold per Month'
            );

            // For the Participation by event type 
            const participationData = await fetch(`${baseUrl}/participation/type`).then(res => res.json());
            const typeLabels = participationData.map(row => row.eventType || 'Unknown');
            const participantCounts = participationData.map(row => parseInt(row.participants));

            createChart(
                document.getElementById('participationChart'),
                'bar',
                typeLabels,
                participantCounts,
                'Participants per Event Type'
            );

        } catch (err) {
            console.error('Error loading analytics:', err);
        }
    });
</script>

    <!-- IF USING ADMIN-DASHBOARD-PLAIN FUNCTIONS
<script src="./admin-dashboard-plain.js" defer></script> -->
<script src="admin-dashboard.js"></script>

</body>
</html>
